name: Quote and Date

on:
  schedule:
    - cron: "15 18 * * *" 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme-gtpl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Dependencies
        run: |
          pip install nepali-datetime pytz requests

      - name: Fetch Date, Quote and Update Files
        run: |
          python - <<EOF
          import datetime
          import nepali_datetime
          import requests
          import re
          import pytz
          import json
          
          nepali_tz = pytz.timezone("Asia/Kathmandu")
          current_time = datetime.datetime.now(nepali_tz)
          
          nepali_date = nepali_datetime.date.today().strftime('%A, %d %B %Y')
          english_date = current_time.strftime('%A, %d %B %Y')
          
          quote = ""
          quote_author = ""
          quote_status = "success"
          
          try:
              response = requests.get("https://zenquotes.io/api/random", timeout=10)
              response.raise_for_status()  
              quote_data = response.json()[0]  
              quote = quote_data["q"]
              quote_author = quote_data["a"]
              formatted_quote = f'"{quote}" - {quote_author}'
              print(f"Fetched new quote: {quote_author}")
          except Exception as e:
              print(f"Quote API failed: {e}")
              quote = "oops api fail check repo :("
              quote_author = "API Error"
              formatted_quote = quote
              quote_status = "error"
              print(f"Using error message")
          
          date_data = {
              "nepali_date": nepali_date,
              "english_date": english_date,
              "update_timestamp": current_time.isoformat(),
              "formatted_display": f"English: {english_date} | Nepali: {nepali_date}",
              "short_english": current_time.strftime('%d %b %Y'),
              "short_nepali": nepali_datetime.date.today().strftime('%d %b %Y'),
              "weekday_english": current_time.strftime('%A'),
              "weekday_nepali": nepali_datetime.date.today().strftime('%A'),
              
              "quote": quote,
              "quote_author": quote_author,
              "formatted_quote": formatted_quote,
              "quote_status": quote_status,
              "has_quote_error": quote_status == "error"
          }
          
          with open("date_widget.json", "w", encoding="utf-8") as json_file:
              json.dump(date_data, json_file, ensure_ascii=False, indent=2)
          
          print(f"Created date_widget.json for mobile widget")
          print(f"  English: {english_date}")
          print(f"  Nepali: {nepali_date}")
          print(f"  Quote status: {quote_status}")
          
          with open("README.gtpl", "r", encoding="utf-8") as file:
              gtpl_content = file.read()
          
          updated_content = re.sub(
              r"<!-- QUOTE_START -->.*?<!-- QUOTE_END -->",
              f"<!-- QUOTE_START -->\n*{formatted_quote}*\n<!-- QUOTE_END -->",
              gtpl_content,
              flags=re.DOTALL
          )
          
          updated_content = re.sub(
              r"<!-- DATE_START -->.*?<!-- DATE_END -->",
              f"<!-- DATE_START -->\n*English: {english_date} | Nepali: {nepali_date}*\n<!-- DATE_END -->",
              updated_content,
              flags=re.DOTALL
          )
          
          with open("README.gtpl", "w", encoding="utf-8") as file:
              file.write(updated_content)
          
          print("README.gtpl updated")
          print("=" * 50)
          
          if quote_status == "error":
              print("Quote API failed, but dates updated!")
          else:
              print("All files updated!")
          EOF

      - name: Push All Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          git add README.gtpl date_widget.json
          
          commit_msg="Update: $(date +'%Y-%m-%d %H:%M') - Date & Quote refresh"
          git commit -m "$commit_msg" || echo "No changes to commit"
          
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          echo "Changes pushed to repo"
